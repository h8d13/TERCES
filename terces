#!/bin/bash
REPO="https://github.com/h8d13/TERCES"
VERSION_FILE="version"

[[ "$1" =~ ^(unlock|encrypt|decrypt|reset|version|update)$ ]] || { echo "Usage: $0 unlock | encrypt | decrypt | reset | version | update"; exit 1; }

[[ "$1" == "reset" ]] && { rm -rf .d/ && echo "Cleared all data."; exit 0; }

[[ "$1" == "version" ]] && {
    ver=$(cat "$VERSION_FILE" 2>/dev/null || echo "0000")
    local_hash=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
    echo "TERCES-$ver (commit: $local_hash)"
    git fetch origin --quiet 2>/dev/null
    remote_hash=$(git rev-parse --short origin/master 2>/dev/null || echo "unknown")
    [[ "$local_hash" == "$remote_hash" ]] && echo "Up to date." || echo "Update available: ./terces update"
    exit 0
}

[[ "$1" == "update" ]] && {
    cur_ver=$(cat "$VERSION_FILE" 2>/dev/null || echo "0000")
    cur_hash=$(git rev-parse --short HEAD 2>/dev/null || echo "none")

    # Clone to temp, check file and commit hash
    tmp_dir=$(mktemp -d)
    git clone --depth 1 "$REPO" "$tmp_dir" || { echo "Clone failed"; rm -rf "$tmp_dir"; exit 1; }

    new_ver=$(cat "$tmp_dir/$VERSION_FILE" 2>/dev/null)
    new_hash=$(git -C "$tmp_dir" rev-parse --short HEAD 2>/dev/null)

    if [[ -z "$new_ver" ]]; then
        echo "No version in remote repo. Nothing to update."
        rm -rf "$tmp_dir"
        echo "Cleaning up tmp dir."
        exit 1
    fi

    echo "Current: TERCES-$cur_ver ($cur_hash)"
    echo "Latest:  TERCES-$new_ver ($new_hash)"

    if [[ "$cur_ver" == "$new_ver" ]]; then
        echo "Already on latest."
        rm -rf "$tmp_dir"
        exit 0
    fi

    new_dir="./TERCES-$new_ver"
    mv "$tmp_dir" "$new_dir"

    echo "Installed: $new_dir"
    echo "Data in .d/ stays here. cd $new_dir"
    exit 0
}

python -B z/"$1".py

