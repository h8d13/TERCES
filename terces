#!/usr/bin/env bash
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"
REPO="https://github.com/h8d13/TERCES"
VERSION_FILE="version"

[[ "$1" =~ ^(list|info|setup|unlock|encrypt|decrypt|vault|delete|reset|version|update|portable|ssh|file|keypub|share|unshare|gen|zkp|test|help)$ ]] || { echo "Usage: $0 help"; exit 1; }

[[ "$1" == "reset" ]] && { rm -rf "$SCRIPT_DIR/.d/" && echo "Cleared all data."; exit 0; }
[[ "$1" == "test" ]] && { "$SCRIPT_DIR/tests/${2:-large}" "${@:3}"; exit $?; }

# Get local version from .d/terces-XXXX directory name
get_local_ver() {
    local dir
    dir=$(find "$SCRIPT_DIR/.d" -maxdepth 1 -type d -name 'terces-*' 2>/dev/null | head -1)
    [[ -n "$dir" ]] && basename "$dir" | sed 's/terces-//' || echo "none"
}

[[ "$1" == "version" ]] && {
    local_ver=$(get_local_ver)
    code_ver=$(cat "$SCRIPT_DIR/$VERSION_FILE" 2>/dev/null || echo "0000")
    local_hash=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
    echo "Code:    TERCES-$code_ver ($local_hash)"
    echo "Data:    .d/terces-$local_ver"
    git fetch origin --quiet 2>/dev/null
    remote_hash=$(git rev-parse --short origin/master 2>/dev/null || echo "unknown")
    [[ "$local_hash" == "$remote_hash" ]] && echo "Up to date." || echo "Update available: ./terces update"
    exit 0
}

[[ "$1" == "update" ]] && {
    local_ver=$(get_local_ver)
    code_ver=$(cat "$SCRIPT_DIR/$VERSION_FILE" 2>/dev/null || echo "0000")
    cur_hash=$(git rev-parse --short HEAD 2>/dev/null || echo "none")

    tmp_dir=$(mktemp -d)
    git clone --depth 1 "$REPO" "$tmp_dir" || { echo "Clone failed"; rm -rf "$tmp_dir"; exit 1; }

    new_ver=$(cat "$tmp_dir/$VERSION_FILE" 2>/dev/null)
    new_hash=$(git -C "$tmp_dir" rev-parse --short HEAD 2>/dev/null)

    if [[ -z "$new_ver" ]]; then
        echo "No version in remote repo."
        rm -rf "$tmp_dir"
        exit 1
    fi

    echo "Code:    TERCES-$code_ver ($cur_hash)"
    echo "Data:    .d/terces-$local_ver"
    echo "Latest:  TERCES-$new_ver ($new_hash)"

    # Warn if data was created with different code version
    if [[ "$local_ver" != "none" && "$local_ver" != "$code_ver" ]]; then
        echo ""
        echo "Warning: Data created with TERCES-$local_ver, code is TERCES-$code_ver"
        echo "Consider: decrypt with old version, re-encrypt with new."
    fi

    if [[ "$code_ver" == "$new_ver" ]]; then
        echo ""
        echo "Code is latest. No update needed."
        rm -rf "$tmp_dir"
        echo "Cleaned up tmp dir."
        exit 0
    fi

    new_dir="./TERCES-$new_ver"
    mv "$tmp_dir" "$new_dir"

    echo ""
    echo "Installed: $new_dir"
    echo "Data in .d/ stays here."
    echo "To migrate: decrypt here, cd $new_dir, re-encrypt."
    exit 0
}

if [ -x "$SCRIPT_DIR/.venv/bin/python" ]; then
    "$SCRIPT_DIR/.venv/bin/python" -B "$SCRIPT_DIR/z/$1.py" "${@:2}"
else
    python -B "$SCRIPT_DIR/z/$1.py" "${@:2}"
fi

