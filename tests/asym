#!/usr/bin/env bash
# Test large file asymmetric encryption/decryption with integrity check
set -e

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")/.." && pwd)"
TERCES="$SCRIPT_DIR/terces"

SIZE_MB=${1:-10240}  # Default 10GB
TEST_FILE="/tmp/terces_asym_test_${SIZE_MB}mb.bin"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  ASYMMETRIC ENCRYPTION TEST (${SIZE_MB}MB)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

echo -e "\n[1/7] Getting public key (touch your key)..."
PUBKEY=$("$TERCES" keypub 2>/dev/null | tail -1)
echo "Pubkey: ${PUBKEY:0:16}..."

echo -e "\n[2/7] Creating test file..."
dd if=/dev/urandom of="$TEST_FILE" bs=1M count="$SIZE_MB" status=progress 2>&1

echo -e "\n[3/7] Computing original checksum..."
ORIG_SUM=$(sha256sum "$TEST_FILE" | cut -d' ' -f1)
echo "SHA256: ${ORIG_SUM:0:16}..."

echo -e "\n[4/7] Sharing (encrypting for self)..."
"$TERCES" share "$TEST_FILE" "$PUBKEY"

echo -e "\n[5/7] Removing original..."
rm "$TEST_FILE"

echo -e "\n[6/7] Unsharing (touch your key)..."
"$TERCES" unshare "${TEST_FILE}.shrd"

echo -e "\n[7/7] Verifying checksum..."
DEC_SUM=$(sha256sum "$TEST_FILE" | cut -d' ' -f1)
echo "SHA256: ${DEC_SUM:0:16}..."

echo ""
if [ "$ORIG_SUM" = "$DEC_SUM" ]; then
    echo "PASS - Checksums match"
else
    echo "FAIL - Checksums differ!"
    exit 1
fi

rm -f "$TEST_FILE" "${TEST_FILE}.shrd"
echo "Done."
