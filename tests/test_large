#!/bin/bash
# Test large file encryption/decryption with integrity check
set -e

SIZE_MB=${1:-10240}  # Default 10GB
TEST_FILE="/tmp/terces_test_${SIZE_MB}mb.bin"

echo "=== Creating ${SIZE_MB}MB test file ==="
dd if=/dev/urandom of="$TEST_FILE" bs=1M count="$SIZE_MB" status=progress

echo -e "\n=== Computing original checksum ==="
ORIG_SUM=$(sha256sum "$TEST_FILE" | cut -d' ' -f1)
echo "SHA256: $ORIG_SUM"

echo -e "\n=== Encrypting (touch your key) ==="
./terces file enc "$TEST_FILE"

echo -e "\n=== Removing original ==="
rm "$TEST_FILE"

echo -e "\n=== Decrypting (touch your key) ==="
./terces file dec "${TEST_FILE}.trcs"

echo -e "\n=== Computing decrypted checksum ==="
# Find decrypted file (might have _uuid suffix)
DEC_FILE=$(find /tmp -maxdepth 1 -name "terces_test_${SIZE_MB}mb*.bin" -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2)
DEC_SUM=$(sha256sum "$DEC_FILE" | cut -d' ' -f1)
echo "SHA256: $DEC_SUM"

echo -e "\n=== Verifying ==="
if [ "$ORIG_SUM" = "$DEC_SUM" ]; then
    echo "✓ PASS - checksums match!"
else
    echo "✗ FAIL - checksums differ!"
    exit 1
fi

# Cleanup
echo -e "\n=== Cleanup ==="
rm -f "$DEC_FILE" "${TEST_FILE}.trcs"
echo "Done."
