#!/bin/bash
# assumes base-devel and no systemd
# thnx gentoo docs/users
# https://wiki.gentoo.org/wiki/YubiKey/PAM

set -e
# ---- Check deps ----
./build_deps || echo "Failed to setup build deps" && exit 1

# ---- Build in /tmp to avoid unsafe directory names ----
BUILD_DIR="/tmp/pam-u2f-build"
rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

git clone https://github.com/Yubico/pam-u2f.git
cd pam-u2f

autoreconf --install
./configure --with-pam-dir=/usr/lib/security
make
make install
cd /
rm -rf "$BUILD_DIR"



echo "pam-u2f installation complete."
echo "Edit the .cfg then sudo ./terces setup"
echo "After edit /etc/pam.d/system-auth and /etc/pam.d/system-local-login accordingly."

### Passwordless sudo
# edit /etc/pam.d/system-auth # tested on open-rc
# first laxist so that we don't lock out user
#auth        sufficient pam_u2f.so      cue authfile=/etc/u2f_mappings

#required (disables password)               #interactive   #path/to/userorglobal/mappings

#pinverification=1 # remove "cue" if using
#userpresence=1 # same

#[cue_prompt=they wants to touches its.]

##Example full setup:
#auth       sufficient                              pam_u2f.so           pinverification=1 cue [cue_prompt=Touch security key.] authfile=/etc/u2f_mappings

## SDDM integration (trace system-login > system-local-login)
#edit /etc/pam.d/system-local-login
#auth       sufficient pam_u2f.so       cue authfile=/etc/u2f_mappings

## Can now enter empty password and key should flash for input and if you do enter password would also flash for input.

### Using custom rp_id (portable setup)
# If you set a custom rp_id in terces.cfg (e.g. "pam://a1b2c3d4") for portability,
# PAM needs the same origin to find the credential:
#
#auth       sufficient pam_u2f.so       origin=pam://a1b2c3d4 cue authfile=/etc/u2f_mappings
#
# Without origin=, PAM defaults to pam://hostname which won't match your portable credential.
#
# Two options:
# 1. Separate credentials - register once for PAM (default rp_id), once for TERCES (custom rp_id)
#    Your key can hold multiple credentials (check: fido2-token -I /dev/hidraw0 | grep "remaining rk")
#
# 2. Same credential - use custom rp_id everywhere, configure PAM with origin=pam://your-rp-id
#    Portable across machines, but PAM config must match on each machine 
